name: Bootstrap + Build LSPosed Module

on:
  workflow_dispatch:
  push:
    paths:
      - "app/**"
      - "gradle/**"
      - ".github/workflows/**"
      - "build.gradle"
      - "settings.gradle"
      - "gradle.properties"
      - "gradlew"
      - "gradlew.bat"

permissions:
  contents: write

jobs:
  bootstrap-and-build:
    runs-on: ubuntu-latest

    env:
      APP_ID: io.github.pixelnfcjapanskuhook
      NAMESPACE: io.github.pixelnfcjapanskuhook
      TARGET_PKG: com.google.android.pixelnfc
      AGP_VERSION: "8.2.2"
      GRADLE_VERSION: "8.2"
      COMPILE_SDK: "34"
      BUILD_TOOLS: "34.0.0"
      MIN_SDK: "24"
      TARGET_SDK: "34"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "tools platform-tools platforms;android-34 build-tools;34.0.0"

      - name: Bootstrap project (generate full Android project if missing)
        shell: bash
        run: |
          set -euxo pipefail

          # 如果已经有 gradlew 和 app/build.gradle，就认为工程已存在（不会重复生成）
          if [[ -f "gradlew" && -f "app/build.gradle" ]]; then
            echo "Project already exists, skip bootstrap."
            exit 0
          fi

          # ====== 生成目录 ======
          mkdir -p app/src/main/java/$(echo "${NAMESPACE}" | tr '.' '/')
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/assets
          mkdir -p gradle/wrapper

          # ====== settings.gradle (Groovy) ======
          cat > settings.gradle <<'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
                  maven { url 'https://api.xposed.info/' }
              }
          }

          rootProject.name = "PixelNfcJapanSkuHook"
          include ':app'
          EOF

          # ====== 顶层 build.gradle ======
          cat > build.gradle <<EOF
          plugins {
              id 'com.android.application' version '${AGP_VERSION}' apply false
          }
          EOF

          # ====== gradle.properties ======
          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # ====== app/build.gradle ======
          cat > app/build.gradle <<EOF
          plugins {
              id 'com.android.application'
          }

          android {
              namespace '${NAMESPACE}'
              compileSdk ${COMPILE_SDK}

              defaultConfig {
                  applicationId '${APP_ID}'
                  minSdk ${MIN_SDK}
                  targetSdk ${TARGET_SDK}
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
                  debug {
                      minifyEnabled false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }

          dependencies {
              // Xposed API：必须 compileOnly，运行时由 LSPosed/Xposed 提供
              compileOnly 'de.robv.android.xposed:api:82'

              implementation 'androidx.appcompat:appcompat:1.6.1'
          }
          EOF

          # ====== proguard-rules.pro ======
          cat > app/proguard-rules.pro <<'EOF'
          # no-op
          EOF

          # ====== AndroidManifest.xml ======
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <application
                  android:label="@string/app_name"
                  android:allowBackup="false"
                  android:supportsRtl="true">

                  <!-- LSPosed / Xposed 模块声明 -->
                  <meta-data android:name="xposedmodule" android:value="true" />
                  <meta-data android:name="xposeddescription" android:value="Force PixelNFC isDeviceJapanSku() to return true" />
                  <meta-data android:name="xposedminversion" android:value="82" />

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

              </application>

          </manifest>
          EOF

          # ====== strings.xml ======
          cat > app/src/main/res/values/strings.xml <<'EOF'
          <resources>
              <string name="app_name">Pixel NFC Japan Hook</string>
          </resources>
          EOF

          # ====== layout ======
          cat > app/src/main/res/layout/activity_main.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical"
              android:gravity="center"
              android:layout_width="match_parent"
              android:layout_height="match_parent">

              <TextView
                  android:text="LSPosed PixelNFC JapanSku Hook Module"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content" />
          </LinearLayout>
          EOF

          # ====== MainActivity ======
          cat > app/src/main/java/$(echo "${NAMESPACE}" | tr '.' '/')/MainActivity.java <<EOF
          package ${NAMESPACE};

          import android.os.Bundle;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
              }
          }
          EOF

          # ====== XposedInit (你的 Hook) ======
          cat > app/src/main/java/$(echo "${NAMESPACE}" | tr '.' '/')/XposedInit.java <<EOF
          package ${NAMESPACE};

          import de.robv.android.xposed.IXposedHookLoadPackage;
          import de.robv.android.xposed.XC_MethodReplacement;
          import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;

          import static de.robv.android.xposed.XposedHelpers.findAndHookMethod;

          public class XposedInit implements IXposedHookLoadPackage {

              @Override
              public void handleLoadPackage(final LoadPackageParam lpparam) throws Throwable {

                  if (!"${TARGET_PKG}".equals(lpparam.packageName)) return;

                  findAndHookMethod(
                          "com.google.android.pixelnfc.provider.DeviceInfoContentProvider",
                          lpparam.classLoader,
                          "isDeviceJapanSku",
                          String.class,
                          new XC_MethodReplacement() {
                              @Override
                              protected Object replaceHookedMethod(MethodHookParam param) {
                                  return true;
                              }
                          }
                  );
              }
          }
          EOF

          # ====== assets/xposed_init ======
          echo "${NAMESPACE}.XposedInit" > app/src/main/assets/xposed_init

          echo "Bootstrap files generated."

      - name: Generate Gradle Wrapper (if missing)
        shell: bash
        run: |
          set -euxo pipefail
          if [[ -f "gradlew" ]]; then
            echo "Gradle wrapper already exists."
            chmod +x ./gradlew
            exit 0
          fi

          curl -fsSL "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" -o /tmp/gradle.zip
          unzip -q /tmp/gradle.zip -d /tmp
          /tmp/gradle-${GRADLE_VERSION}/bin/gradle wrapper --gradle-version "${GRADLE_VERSION}"
          chmod +x ./gradlew

      - name: Commit bootstrap project back to repo (only on manual run)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euxo pipefail
          git status --porcelain
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "Bootstrap LSPosed module project"
          git push origin "HEAD:${GITHUB_REF_NAME}"

      - name: Build Debug APK
        run: ./gradlew --no-daemon :app:assembleDebug

      - name: Upload Debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
